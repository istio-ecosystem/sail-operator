// Variables embedded for GitHub compatibility
:istio_latest_version: 1.26.3
:istio_latest_version_revision_format: 1-26-3
:istio_latest_tag: v1.26-latest
:istio_release_name: release-1.26
:istio_latest_minus_one_version: 1.26.2
:istio_latest_minus_one_version_revision_format: 1-26-2

link:../README.adoc[Return to Project Root]

[[updating-istio-in-ambient-mode]]
== Updating Istio in Ambient Mode

This guide provides procedures for updating Istio when deployed in ambient mode using the Sail Operator. The upgrade process includes updating the Istio control plane, IstioCNI, and ZTunnel components.

For general information about update strategies (InPlace and RevisionBased) and versioning, see link:../update-strategy/update-strategy.adoc#update-strategy[Update Strategy].

For information about installing Istio in ambient mode, see link:./istio-ambient-mode.adoc#introduction-to-istio-ambient-mode[Istio Ambient Mode].

*Note:* Istio's ambient mode is available starting from Istio version 1.24.0.

*Key differences in ambient mode:*

* Updates involve three components: Control Plane, IstioCNI, and ZTunnel
* Components must be updated in sequence: Control Plane → IstioCNI → ZTunnel
* No pod restart needed for workloads (workloads automatically connect to new control plane)

'''

[[understanding-versioning]]
== Understanding Versioning

For information about semantic versioning and version numbering (X.Y.Z format), see link:../update-strategy/update-strategy.adoc#understanding-versioning[Understanding Versioning].

'''

[[selecting-update-strategy]]
== Selecting an Update Strategy

The Sail Operator supports two update strategies: InPlace and RevisionBased. For detailed information about these strategies, their configuration, and general behavior, see link:../update-strategy/update-strategy.adoc#update-strategy[Update Strategy].

**Ambient mode considerations:**

IMPORTANT: **InPlace is the recommended update strategy for ambient mode.** RevisionBased updates have significant limitations when used with ambient mode and require manual intervention. See the <<updating-with-revisionbased-strategy,RevisionBased Strategy section>> for details.

In ambient mode, both strategies require additional steps to update IstioCNI and ZTunnel components after the control plane upgrade:

* **InPlace** (Recommended) - Updates all components directly, with workloads immediately connecting to the new control plane. This is the straightforward and recommended approach for ambient mode.
* **RevisionBased** (Limited Support) - While theoretically possible, this strategy has significant limitations in ambient mode: only one ztunnel instance can run cluster-wide, and manual CRD synchronization is required between Istio and ZTunnel revisions.

'''

[[updating-with-inplace-strategy]]
== Updating with InPlace Strategy

For general information about the InPlace strategy, see link:../update-strategy/update-strategy.adoc#inplace[InPlace].

*Ambient-specific considerations:*

In ambient mode, the InPlace update strategy updates all components directly, with workloads immediately connecting to the new control plane version. The IstioCNI and ZTunnel components are also updated using rolling updates. To maintain compatibility between the ambient data plane components and the control plane, you can upgrade only one minor version at a time.

While the InPlace strategy offers simplicity and efficiency, there's a slight possibility of application traffic interruption during control plane updates. Running multiple replicas of the Istio control plane (istiod) can help minimize this risk, but does not eliminate it entirely. For more details about ambient mode upgrade behavior, see the https://istio.io/latest/docs/ambient/upgrade/helm/#understanding-ambient-mode-upgrades[Istio ambient mode upgrade documentation].

[[selecting-inplace-strategy]]
=== Selecting InPlace Strategy

To select the InPlace strategy, set the `spec.updateStrategy.type` value in the Istio resource to `InPlace`. For configuration details and examples, see link:../update-strategy/update-strategy.adoc#inplace[InPlace].

**Important for ambient mode:** When using the InPlace strategy with ambient mode, ensure that all three components (Istio, IstioCNI, and ZTunnel) are updated to compatible versions in the following order:

1. Istio control plane
2. IstioCNI
3. ZTunnel

*Tip:* Running the Istio resource in High Availability mode can help reduce traffic disruptions during updates, though some brief disruption may still occur. For more information, see link:../general/istiod-ha.adoc#running-istiod-in-ha-mode[Istiod HA guide].

[[updating-istio-control-plane-with-inplace-strategy]]
=== Updating Istio control plane with InPlace strategy

When updating Istio using the InPlace strategy in ambient mode, you can increment the version by only one minor release at a time. To update by more than one minor version, you must increment the version after each update. The update process is complete after all ambient components (Istio control plane, IstioCNI, and ZTunnel) have been updated.

[[update-the-istio-control-plane]]
==== Update the Istio Control Plane

You can update the Istio control plane version by changing the version in the Istio resource. When using the InPlace update strategy, the Sail Operator replaces the existing istiod deployment with a new version. The old istiod pod is terminated and a new pod with the updated version is created.

*Prerequisites:*

* You have cluster-admin access to your Kubernetes cluster.
* You have installed the Sail Operator.
* You have deployed Istio in ambient mode with the InPlace update strategy.
* The Istio resource named `default` is deployed in the `istio-system` namespace with the InPlace update strategy.
* You have verified the current version and the Istio resource is in a Healthy state by running the following command:

[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl get istio -n istio-system
NAME      REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
default   1           1       1        default           Healthy   v1.26.3   7d
----

*Procedure:*

. Update the Istio resource version. For example, to update to Istio 1.26.4, set the `spec.version` field to `v1.26.4` by running the following command:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl patch istio default -n istio-system --type='merge' -p '{"spec":{"version":"v1.26.4"}}'
----

. Wait for the Istio control plane to become ready:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl wait --for=condition=Ready istios/default -n istio-system --timeout=5m
----

. Verify the Istio resource shows the new version and is in a Healthy state:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl get istio -n istio-system
NAME      REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
default   1           1       1        default           Healthy   v1.26.4   7d1h
----

. Verify the istiod pod is running with the new version and check its status:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl get pods -n istio-system -l app=istiod
NAME                             READY   STATUS    RESTARTS   AGE
istiod-default-6bd6b8664b-x7k2m  1/1     Running   0          2m15s
----
+
Optionally, verify the control plane is functioning correctly by checking the logs:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl logs -n istio-system -l app=istiod --tail=50 | grep -i "version\|ready"
----

[[update-istiocni-and-ztunnel]]
==== Update IstioCNI and ZTunnel

After updating the Istio control plane, update the IstioCNI and ZTunnel components to maintain compatibility between the control plane and ambient data plane components.

. Update the IstioCNI resource to the same version as the control plane:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl patch istiocni -n istio-cni default --type='merge' -p '{"spec":{"version":"v1.26.4"}}'
----
+
Wait for the IstioCNI resource to become ready:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl wait --for=condition=Ready istiocnis/default --timeout=5m
----

. Update the ZTunnel resource to the same version as the control plane:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl patch ztunnel -n ztunnel default --type='merge' -p '{"spec":{"version":"v1.26.4"}}'
----
+
Wait for the ZTunnel resource to become ready:
+
[source,bash,subs="attributes+",name="ambient-inplace-update-strategy"]
----
$ kubectl wait --for=condition=Ready ztunnel/default --timeout=10m
----
+
*Note:* The ZTunnel DaemonSet update may take several minutes as pods are updated node-by-node to minimize disruption.

For detailed information about updating IstioCNI, see link:../../README.md#updating-istiocni[IstioCNI Update Procedure in README]. For ZTunnel update procedures, refer to section "Common Update Procedures for Ambient Components".

[[recommendations-for-inplace-strategy-in-ambient-mode]]
=== Recommendations for InPlace strategy in Ambient Mode

* **High Availability:** Configure the istiod deployment with multiple replicas to help reduce disruptions during updates. Note that even with HA mode, some brief traffic disruption may still occur during control plane upgrades. See the link:../general/istiod-ha.adoc#running-istiod-in-ha-mode[Istiod HA guide] for more information.
* **ZTunnel Updates:** The ZTunnel DaemonSet uses a RollingUpdate strategy by default, which updates pods one node at a time. Monitor the rollout to ensure it completes successfully.
* **Maintenance Window:** While ambient mode is designed to minimize disruption, it's recommended to perform upgrades during a maintenance window.
* **Testing:** Always test the upgrade process in a non-production environment first.

'''

[[updating-with-revisionbased-strategy]]
== Updating with RevisionBased Strategy

For general information about the RevisionBased strategy, see link:../update-strategy/update-strategy.adoc#revisionbased[RevisionBased].

WARNING: **RevisionBased updates are not fully supported in ambient mode and require significant manual intervention.** This strategy has the following limitations when used with ambient mode:

* **Single ZTunnel Instance:** Only one ztunnel instance can run in the cluster at any time, which limits the canary upgrade capabilities typically available with RevisionBased updates.
* **Manual CRD Synchronization:** You must manually synchronize CRDs between Istio control plane revisions and the ZTunnel instance, primarily managing the revision name configuration.
* **Complex Migration:** The ztunnel must be manually reconfigured to point to the appropriate control plane revision during migration.

**Recommendation:** Use the InPlace update strategy for ambient mode deployments. It provides a simpler, more reliable upgrade path. The procedures below are provided for advanced use cases where RevisionBased updates are required, but users should be prepared for additional manual configuration steps.

*Ambient-specific considerations:*

When using ambient mode with the RevisionBased strategy, the IstioCNI component can work with multiple control plane versions during the workload migration period. However, since only one ztunnel instance can run cluster-wide, the migration process requires careful coordination. The ztunnel must be manually configured to connect to the correct control plane revision, and CRD synchronization between revisions must be maintained manually to ensure compatibility.

[[selecting-revisionbased-strategy]]
=== Selecting RevisionBased Strategy

To deploy Istio with the RevisionBased strategy, set the `spec.updateStrategy.type` value in the Istio resource to `RevisionBased` and configure the `inactiveRevisionDeletionGracePeriodSeconds`. For configuration details and examples, see link:../update-strategy/update-strategy.adoc#revisionbased[RevisionBased].

When using the RevisionBased strategy, the Operator creates a new IstioRevision resource with the name `<istio_resource_name>-<version>`. For example, if the Istio resource is named `default` and the version is `v1.26.3`, the IstioRevision resource name would be `default-v1-26-3`.

[[updating-istio-control-plane-with-revisionbased-strategy]]
=== Updating Istio Control Plane with RevisionBased Strategy

When updating Istio using the RevisionBased strategy in ambient mode, you can upgrade by more than one minor version at a time. The Sail Operator creates a new IstioRevision resource for each change to the .spec.version field and deploys a corresponding control plane instance.

[[update-the-istio-control-plane-revisionbased]]
==== Update the Istio Control Plane

You can update the Istio control plane version by changing the version in the Istio resource. When using the RevisionBased update strategy, the Sail Operator creates a new istiod deployment alongside the existing one, allowing for a canary upgrade of the control plane. Both control planes run simultaneously until all workloads are migrated to the new version. The new control plane is created with a revision name in the format `<istio-name>-<version>`.

NOTE: While multiple control plane revisions can run simultaneously, remember that only one ztunnel instance can exist cluster-wide in ambient mode. This limits the full canary upgrade benefits typically available with RevisionBased updates in sidecar mode.

*Prerequisites:*

* You have cluster-admin access to your Kubernetes cluster.
* You have installed the Sail Operator.
* You have deployed Istio in ambient mode with the RevisionBased update strategy.
* The Istio resource named `default` is deployed in the `istio-system` namespace with the RevisionBased update strategy.
* You have verified the current version and the Istio resource is in a Healthy state by running the following commands:

[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get istio default -n istio-system -o yaml | grep -A 3 updateStrategy
  updateStrategy:
    type: RevisionBased
    inactiveRevisionDeletionGracePeriodSeconds: 30
----

[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get istio -n istio-system
NAME      REVISIONS   READY   IN USE   ACTIVE REVISION     STATUS    VERSION   AGE
default   1           1       1        default-v1-26-3     Healthy   v1.26.3   7d
----

[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get istiorevision -n istio-system
NAME              TYPE    READY   STATUS    IN USE   VERSION   AGE
default-v1-26-3   Local   True    Healthy   True     v1.26.3   7d
----

* The `inactiveRevisionDeletionGracePeriodSeconds` is configured in the Istio resource.

*Procedure:*

. Update the Istio resource version. For example, to update to Istio 1.26.4, set the `spec.version` field to `v1.26.4` by running the following command:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl patch istio default -n istio-system --type='merge' -p '{"spec":{"version":"v1.26.4"}}'
----
+
This command creates a new IstioRevision resource and a new istiod deployment for the new version.

. Monitor the new istiod pod creation:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get pods -n istio-system -l app=istiod -w
----

. Wait for the new control plane revision to become ready:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl wait --for=condition=Ready istios/default -n istio-system --timeout=5m
----

. Verify both revisions are now running. The Istio resource should show 2 revisions:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get istio -n istio-system
NAME      REVISIONS   READY   IN USE   ACTIVE REVISION     STATUS    VERSION   AGE
default   2           2       1        default-v1-26-4     Healthy   v1.26.4   7d1h
----

. List the IstioRevision resources to see both versions:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get istiorevision -n istio-system
NAME              TYPE    READY   STATUS    IN USE   VERSION   AGE
default-v1-26-3   Local   True    Healthy   True     v1.26.3   7d
default-v1-26-4   Local   True    Healthy   False    v1.26.4   2m
----
+
The old revision shows `IN USE: True` because workloads are still connected to it. The new revision shows `IN USE: False` until workloads are migrated.

. Confirm both control plane pods are running:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get pods -n istio-system -l app=istiod
NAME                                      READY   STATUS    RESTARTS   AGE
istiod-default-v1-26-3-6bd6b8664b-x7k2m   1/1     Running   0          7d
istiod-default-v1-26-4-7c8e9d775c-y8l3n   1/1     Running   0          2m
----

. Verify the new control plane is functioning by checking its logs:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl logs -n istio-system istiod-default-v1-26-4-7c8e9d775c-y8l3n --tail=50 | grep -i "version\|ready"
----

After creating the new Istio control plane revision, proceed to update IstioCNI and ZTunnel. For IstioCNI update procedures, see link:../../README.md#updating-istiocni[IstioCNI Update Procedure in README]. For ZTunnel update instructions, refer to section "Common Update Procedures for Ambient Components". Note that IstioCNI is compatible with multiple control plane versions and will continue to handle traffic for both the old and new control planes during the migration period.

[[migrate-ambient-workloads-to-new-revision]]
==== Migrate Ambient Workloads to New Revision

Unlike sidecar mode, ambient mode workloads don't use namespace labels like `istio.io/rev` for version selection. Instead, ambient workloads automatically connect to the active control plane revision. However, to ensure proper migration:

. Verify that your ambient namespaces are still labeled correctly:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get namespace bookinfo --show-labels | grep istio
NAME       STATUS   AGE   LABELS
bookinfo   Active   7d    istio-discovery=enabled,istio.io/dataplane-mode=ambient
----

. The ambient workloads automatically use the new control plane. Verify connectivity:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ istioctl ztunnel-config workloads --namespace ztunnel | grep bookinfo
----

. For more controlled migration, you can temporarily restart application pods to ensure they pick up any configuration changes:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl rollout restart deployment -n <NAMESPACE>
----

. Wait for the rollout to complete:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl rollout status deployment -n <NAMESPACE>
----

. Verify the workloads are functioning correctly:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl exec "$(kubectl get pod -l app=ratings -n bookinfo -o jsonpath='{.items[0].metadata.name}')" -c ratings -n bookinfo -- curl -sS productpage:9080/productpage | grep -o "<title>.*</title>"
<title>Simple Bookstore App</title>
----

[[verify-old-revision-cleanup]]
==== Verify Old Revision Cleanup

. After the grace period (specified in `inactiveRevisionDeletionGracePeriodSeconds`), verify that the old revision has been cleaned up:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get istiorevision -n istio-system
NAME              TYPE    READY   STATUS    IN USE   VERSION   AGE
default-v1-26-4   Local   True    Healthy   True     v1.26.4   35m
----

. Confirm only the new control plane pods are running:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get pods -n istio-system -l app=istiod
NAME                                      READY   STATUS    RESTARTS   AGE
istiod-default-v1-26-4-7c8e9d775c-y8l3n   1/1     Running   0          35m
----

. Verify the Istio resource reflects the single active revision:
+
[source,bash,subs="attributes+",name="ambient-revision-based-strategy"]
----
$ kubectl get istio -n istio-system
NAME      REVISIONS   READY   IN USE   ACTIVE REVISION     STATUS    VERSION   AGE
default   1           1       1        default-v1-26-4     Healthy   v1.26.4   7d1h
----

If you have deployed waypoint proxies, verify them after the upgrade. Refer to <<updating-waypoint-proxies-if-deployed,Updating Waypoint Proxies (If Deployed)>> for detailed instructions.

[[rollback-procedure]]
=== Rollback Procedure

If you encounter issues during the RevisionBased upgrade, you can roll back before the old revision is deleted:

. Verify the old revision is still available:
+
[source,bash,subs="attributes+",name="ambient-revision-rollback"]
----
$ kubectl get istiorevision -n istio-system
NAME              TYPE    READY   STATUS    IN USE   VERSION   AGE
default-v1-26-3   Local   True    Healthy   False    v1.26.3   7d
default-v1-26-4   Local   True    Healthy   True     v1.26.4   10m
----

. Roll back the Istio resource to the previous version:
+
[source,bash,subs="attributes+",name="ambient-revision-rollback"]
----
$ kubectl patch istio default -n istio-system --type='merge' -p '{"spec":{"version":"v1.26.3"}}'
----

. Roll back IstioCNI and ZTunnel if needed:
+
[source,bash,subs="attributes+",name="ambient-revision-rollback"]
----
$ kubectl patch istiocni default --type='merge' -p '{"spec":{"version":"v1.26.3"}}'
$ kubectl patch ztunnel default --type='merge' -p '{"spec":{"version":"v1.26.3"}}'
----

. Restart application pods:
+
[source,bash,subs="attributes+",name="ambient-revision-rollback"]
----
$ kubectl rollout restart deployment -n <NAMESPACE>
----

'''

[[common-update-procedures-for-ambient-components]]
== Common Update Procedures for Ambient Components

This section provides common procedures for updating ambient mode components (IstioCNI, ZTunnel, and Waypoint Proxies) that are applicable to both InPlace and RevisionBased update strategies. Follow these procedures after updating the Istio control plane as described in your chosen update strategy.

[[updating-istiocni]]
=== Updating IstioCNI

For detailed IstioCNI update procedures, see link:../../README.md#updating-istiocni[IstioCNI Update Procedure in README].

[[updating-ztunnel]]
=== Updating ZTunnel

After updating IstioCNI, update the ZTunnel component. The Sail Operator updates the ZTunnel DaemonSet, which runs the L4 node proxies. The ZTunnel pods are updated using a rolling update strategy, updating one node at a time to maintain mesh connectivity during the upgrade. Existing connections are maintained while new connections use the updated ZTunnel proxies.

*Prerequisites:*

* You have cluster-admin access to your Kubernetes cluster.
* You have successfully updated the Istio control plane to the desired version (InPlace strategy) or created a new control plane revision (RevisionBased strategy).
* You have successfully updated the IstioCNI resource to the desired version.
* The ZTunnel resource named `default` is deployed in the `ztunnel` namespace.

*Procedure:*

. Update the ZTunnel resource version. For example, to update to Istio 1.26.4, set the `spec.version` field to `v1.26.4` by running the following command:
+
[source,bash,subs="attributes+",name="ambient-update-ztunnel"]
----
$ kubectl patch ztunnel -n ztunnel default --type='merge' -p '{"spec":{"version":"v1.26.4"}}'
----

. Monitor the ZTunnel DaemonSet rollout:
+
[source,bash,subs="attributes+",name="ambient-update-ztunnel"]
----
$ kubectl rollout status daemonset/ztunnel -n ztunnel
----

*Note:* The ZTunnel DaemonSet update may take several minutes as pods are updated node-by-node to minimize disruption to ambient workloads.

. Wait for the ZTunnel resource to become ready:
+
[source,bash,subs="attributes+",name="ambient-update-ztunnel"]
----
$ kubectl wait --for=condition=Ready ztunnel/default --timeout=10m
----

. Verify the ZTunnel resource shows the new version and all pods are running:
+
[source,bash,subs="attributes+",name="ambient-update-ztunnel"]
----
$ kubectl get ztunnel
NAME      READY   STATUS    VERSION   AGE
default   True    Healthy   v1.26.4   7d1h

$ kubectl get pods -n ztunnel -o wide
NAME              READY   STATUS    RESTARTS   AGE   NODE
ztunnel-2w5mj     1/1     Running   0          5m    node1.example.com
ztunnel-6njq8     1/1     Running   0          4m    node2.example.com
ztunnel-96j7k     1/1     Running   0          3m    node3.example.com
----

*Note:* When using the RevisionBased strategy, only one ztunnel instance can run cluster-wide. During migration, you must manually configure the ztunnel to point to the appropriate control plane revision and manually synchronize CRDs to ensure compatibility. This limitation reduces the canary upgrade capabilities typically available with RevisionBased updates in sidecar mode.

[[verifying-ambient-workloads]]
=== Verifying Ambient Workloads

After updating all ambient components, verify that your ambient workloads are functioning correctly:

NOTE: The following examples use the `bookinfo` sample application running in the `bookinfo` namespace. Adapt these steps to your own application namespaces and pod labels when verifying your ambient workloads.

. Verify that your ambient workloads are still functioning correctly:
+
[source,bash,subs="attributes+",name="ambient-verify-workloads"]
----
$ kubectl get pods -n bookinfo
----

. Verify ZTunnel is processing traffic for your ambient workloads:
+
[source,bash,subs="attributes+",name="ambient-verify-workloads"]
----
$ istioctl ztunnel-config workloads --namespace ztunnel | grep bookinfo
----

. Test connectivity within your mesh:
+
[source,bash,subs="attributes+",name="ambient-verify-workloads"]
----
$ kubectl exec "$(kubectl get pod -l app=ratings -n bookinfo -o jsonpath='{.items[0].metadata.name}')" -c ratings -n bookinfo -- curl -sS productpage:9080/productpage | grep -o "<title>.*</title>"
<title>Simple Bookstore App</title>
----

[[updating-waypoint-proxies-if-deployed]]
=== Updating Waypoint Proxies (If Deployed)

If you have deployed waypoint proxies in your ambient mesh for Layer 7 features, they should be verified after the control plane upgrade. For detailed information about waypoint proxies, see link:./istio-ambient-waypoint.adoc#introduction-to-istio-waypoint-proxy[Introduction to Istio Waypoint Proxy].

. List existing waypoint proxies:
+
[source,bash,subs="attributes+",name="ambient-update-waypoint"]
----
$ kubectl get gateway -n bookinfo
NAME       CLASS              ADDRESS        PROGRAMMED   AGE
waypoint   istio-waypoint     10.96.123.45   True         7d
----

. Waypoint proxies should automatically update to use the new control plane. Verify the waypoint proxy pods are running:
+
[source,bash,subs="attributes+",name="ambient-update-waypoint"]
----
$ kubectl get pods -n bookinfo -l gateway.networking.k8s.io/gateway-name=waypoint
NAME                       READY   STATUS    RESTARTS   AGE
waypoint-5d9c8b7f9-abc12   1/1     Running   0          5m
----

. Verify L7 features are working correctly by testing traffic routing and authorization policies. See link:./istio-ambient-waypoint.adoc#layer-7-features-in-ambient-mode[Layer 7 Features in Ambient Mode] for examples.

'''

[[special-considerations-for-ambient-mode-upgrades]]
== Special Considerations for Ambient Mode Upgrades

[[ztunnel-daemonset-updates]]
=== ZTunnel DaemonSet Updates

The ZTunnel component runs as a DaemonSet on every node in the cluster. During upgrades:

* **Rolling Updates:** ZTunnel uses a RollingUpdate strategy, updating one node at a time by default.
* **Minimal Disruption:** While a node's ZTunnel pod is restarting, new connections may experience brief latency, but existing connections are maintained.
* **Node-by-Node:** The update process ensures that at least one ZTunnel pod is always available on each node before proceeding to the next.
* **Monitoring:** Monitor the ZTunnel DaemonSet rollout status:

[source,bash,subs="attributes+"]
----
$ kubectl rollout status daemonset/ztunnel -n ztunnel
----

[[control-plane-and-data-plane-version-skew]]
=== Control Plane and Data Plane Version Skew

In ambient mode, version skew between components is handled differently than in sidecar mode:

* **Supported Skew:** The ztunnel at version 1.x is compatible with the control plane at version 1.x+1 and 1.x.
* **Testing Required:** Always test your specific version combinations in a non-production environment.
* **Recommendation:** Keep all components (Istio, IstioCNI, ZTunnel) at the same version when possible.

[[waypoint-proxy-compatibility]]
=== Waypoint Proxy Compatibility

If you have deployed waypoint proxies for L7 features:

* **Automatic Updates:** Waypoint proxies automatically reference the active control plane revision.
* **Gateway API:** Waypoint proxies are deployed using Kubernetes Gateway resources and are managed automatically by Istiod.
* **Verification:** Test L7 features after the upgrade to ensure waypoint proxies are functioning correctly. See link:./istio-ambient-waypoint.adoc#layer-7-features-in-ambient-mode[Layer 7 Features in Ambient Mode] for testing examples.

**Update Behavior by Strategy:**

* **InPlace Strategy:** Waypoint proxies transition directly to the new control plane version
* **RevisionBased Strategy:** Waypoint proxies can function with both control plane revisions during migration. However, note that the single-ztunnel limitation still applies to the ambient data plane.

**Cross-Namespace Waypoints:**

Verify labels remain in place for cross-namespace waypoint usage:

[source,bash,subs="attributes+"]
----
$ kubectl get ns bookinfo --show-labels | grep waypoint
bookinfo  Active  istio.io/use-waypoint-namespace=foo,istio.io/use-waypoint=waypoint-foo
----

For detailed waypoint update procedures, see link:./istio-ambient-waypoint.adoc#updating-waypoint-proxies[Updating Waypoint Proxies].

[[impact-on-existing-ambient-workloads]]
=== Impact on Existing Ambient Workloads

During ambient mode upgrades:

When upgrading the ambient cluster, new mTLS connections continue to function normally throughout the upgrade process. However, upgrading ztunnel will cause any existing long-lived TCP connections (including mTLS connections) on the upgraded node to reset after a grace period. To minimize disruption during production upgrades, node cordoning, blue/green node pools are recommended.

[[discovery-selectors-impact]]
=== Discovery Selectors Impact

If you're using discovery selectors to scope your mesh:

* **Label Verification:** Ensure that all required namespaces (istio-system, istio-cni, ztunnel) retain their discovery selector labels during upgrades.
* **Namespace Discovery:** The control plane must discover all necessary namespaces for proper operation.
* **Verification Command:**

[source,bash,subs="attributes+"]
----
$ kubectl get namespace -l istio-discovery=enabled
NAME           STATUS   AGE
istio-system   Active   7d
istio-cni      Active   7d
ztunnel        Active   7d
bookinfo       Active   7d
----

[[troubleshooting-common-issues]]
=== Troubleshooting Common Issues

**For common issues:**

* Ztunnel Troubleshoot: https://istio.io/latest/docs/ambient/usage/troubleshoot-ztunnel/
* Waypoint Troubleshoot: https://istio.io/latest/docs/ambient/usage/troubleshoot-ztunnel/

'''

[[additional-resources]]
== Additional Resources

* **Upstream Istio Ambient Documentation:** https://istio.io/latest/docs/ambient/
* **Istio Upgrade Documentation:** https://istio.io/latest/docs/setup/upgrade/
* **Istio Ambient Mode Installation:** link:./istio-ambient-mode.adoc#introduction-to-istio-ambient-mode[Istio Ambient Mode]
* **Istio Ambient Waypoint Proxy Guide:** link:./istio-ambient-waypoint.adoc#introduction-to-istio-waypoint-proxy[Istio Ambient Waypoint Proxy]
* **General Update Strategy Documentation:** link:../update-strategy/update-strategy.adoc#update-strategy[Update Strategy]
